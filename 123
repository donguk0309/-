#!/bin/bash

# β… ν™κ²½ λ³€μ μ„¤μ •
NS_NAME="ns_google"
MAIN_IP="10.200.1.1"
NS_IP="192.168.1.100"
SUBNET="24"

echo "[+] λ„¤μ„μ¤νμ΄μ¤ λ° κ°€μƒ μΈν„°νμ΄μ¤ μ„¤μ • μ¤‘..."

# 1. λ„¤μ„μ¤νμ΄μ¤ μƒμ„±
sudo ip netns add $NS_NAME

# 2. veth μΈν„°νμ΄μ¤ μƒμ„± λ° μ—°κ²°
sudo ip link add veth0 type veth peer name veth1
sudo ip link set veth1 netns $NS_NAME

# 3. λ©”μΈ λ„¤μ„μ¤νμ΄μ¤ μ„¤μ •
sudo ip addr add ${MAIN_IP}/${SUBNET} dev veth0
sudo ip link set veth0 up

# 4. λ„¤μ„μ¤νμ΄μ¤ λ‚΄λ¶€ μ„¤μ •
sudo ip netns exec $NS_NAME ip addr add ${NS_IP}/${SUBNET} dev veth1
sudo ip netns exec $NS_NAME ip link set veth1 up
sudo ip netns exec $NS_NAME ip link set lo up

# 5. λ„¤μ„μ¤νμ΄μ¤ λ‚΄μ— ν•„μ”ν• ν¨ν‚¤μ§€ μ„¤μΉ
echo "[+] ns_google λ‚΄λ¶€μ— mysql μ„¤μΉ μ¤‘..."
sudo ip netns exec $NS_NAME apt update -y
sudo ip netns exec $NS_NAME apt install -y mysql-server > /dev/null

# 6. MySQL μ•μ „λ¨λ“ μ‹¤ν–‰ (skip grant tables)
echo "[+] MySQL μ•μ „λ¨λ“λ΅ μ‹μ‘ μ¤‘ (λΉ„λ°€λ²νΈ μ°ν)..."
sudo ip netns exec $NS_NAME bash -c "mysqld_safe --skip-grant-tables &"
sleep 10

# 7. MySQL λ£¨νΈ μ ‘μ† ν…μ¤νΈ λ° μ‚¬μ©μ ν™•μΈ
echo "[+] MySQL λ£¨νΈ κ³„μ •μΌλ΅ λ¬΄λΉ„λ°€λ²νΈ μ ‘μ† μ¤‘..."
sudo ip netns exec $NS_NAME mysql -u root -e "SHOW DATABASES;"
sudo ip netns exec $NS_NAME mysql -u root -e "SELECT user, host FROM mysql.user;"

echo "[+] π‰ μ™„λ£: λ¨μ ν•΄ν‚Ή ν™κ²½ κµ¬μ„± μ„±κ³µ"
